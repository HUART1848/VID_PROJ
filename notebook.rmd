---
title: "VID - Projet - Notebook"
author: "Farouk Ferchichi & Hugo Huart"
date: "`r Sys.Date()`"
output: rmdformats::material
---

# Introduction

_Note: Cliquez sur un graphique pour l'agrandir_

```{r message=FALSE, warning=FALSE}
library(caret)
library(DataExplorer)
library(inspectdf)
library(outliers)
library(rpart)
library(rpart.plot)
library(tidyverse)
```

# Analyse exploratoire

_Note: Cliquez sur un graphique pour l'agrandir_

## Chargement des données

```{r}
cylinders<-read.csv2("data/bands3.csv", dec=".", header=T, na.strings="?")
cylinders<-tibble(cylinders)
head(cylinders)
```

## Premier aperçu et analyse des valeurs manquantes

Nombre de valeurs manquantes par attribut:

```{r}
cylinders %>%
  summarize(across(everything(), ~sum(is.na(.)))) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "NAs") %>%
  arrange(desc(NAs))
```

Proportion des valeurs manquantes par colonne:

```{r}
colMeans(is.na(cylinders)) %>% sort(decreasing = T)
```

Visualisation de la répartition des valeurs manquantes (par type):

```{r fig.align='center', fig.width=6, fig.height=6}
plot_missing(
  cylinders %>% select(where(is.numeric)),
  title="Proportion NA pour attributs numériques")
```

```{r fig.align='center', fig.width=6, fig.height=6}
plot_missing(
  cylinders %>% select(where(is.integer))
, title="Proportions NA des attributs entiers")
```

```{r fig.align='center', fig.width=6, fig.height=6}
plot_missing(
  cylinders %>% select(where(is.character)),
  title="Proportions NA des attributs textuels")
```

Visualisation de la répartition des types d'attributs:

```{r fig.align='center', fig.width=6, fig.height=6}
inspect_types(cylinders) %>% show_plot()
```

## Préparation des données

Séparation des attributs quantitatifs et qualitatifs:

Sur les 40 attributs, ceux situés entre le 2ème et le 20ème inclus sont qualitatifs:

```{r}
idx.quali<-c(2:20, 40)
idx.quali
```

Les autres sont quantitatif:

```{r}
idx.quant<-((1:40)[-idx.quali])
idx.quant
```

### Création de sous-ensembles purement qualitatifs ou quantitatifs

Formatage de la date:

```{r}
cylinders<-cylinders %>%
  mutate(across(date, ymd))
```

Création de l'ensemble qualitatif:

```{r}
cylinders.quali<-cylinders[, idx.quali] %>% mutate(across(where(is.integer), as.factor))
cylinders.quali<-cylinders.quali %>% mutate(across(where(is.character), as.factor))
head(cylinders.quali)
```

Création de l'ensemble quantitatif:

```{r}
cylinders.quant<-cylinders[, idx.quant]
head(cylinders.quant)
```

Affichage du résumé de ces sous-ensembles avant traitement:

```{r}
print(summary(cylinders.quali))
print(summary(cylinders.quant))
```

Affichage de boîtes à moustaches pour chacun des attributs quantitatifs:

```{r fig.align='center', fig.height=8, fig.width=8, warning=FALSE}
cylinders.quant %>%
  gather(key = "Attributs", value = "Valeurs") %>%
  ggplot(aes(x = Attributs, y = Valeurs)) +
  geom_boxplot(outlier.alpha = 0.4, outlier.size = 1) +
  facet_wrap(~Attributs, scale="free", nrow = 5) +
  theme_linedraw()
```

### Nettoyage des données

À l'aide de la librairie `outliers`,
remplacement des valeurs quantitatives aberrantes:

```{r}
cylinders.quant<-cylinders.quant %>%
  mutate(across(-date, ~rm.outlier(., fill=T, median=T)))
```

Remplacement des valeurs numériques manquantes par la médiane de l'attribut:

```{r}
cylinders.quant<-cylinders.quant %>%
  mutate(across(everything(), ~replace_na(., median(., na.rm=T))))
```

Correction des valeurs quantitatives (dupliquées par la case):

```{r}
cylinders.quali<-cylinders.quali %>%
  mutate(across(everything(), ~as.factor(toupper(as.character(.)))))
```

Réunion des valeurs et affichage du résumé après traitement:

```{r}
cylinders<-cbind(cylinders.quant, cylinders.quali)
cylinders %>% summary
```

Certains attributs quantitatifs semblent avoir un grand nombre de classe:

```{r}
cylinders %>%
  select(cylinder_no, customer, job_number) %>%
  mutate(across(everything(), ~n_distinct(.))) %>%
  first
```

On affiche un nuage de points pour chaque attribut quantitatif,
avec une indication de la présence de _banding_.

```{r fig.align='center', fig.height=10, fig.width=10, warning=FALSE}
cylinders %>%
  select(date, where(is.numeric), band_type) %>%
  pivot_longer(c(-date, -band_type), names_to = "variable", values_to  = "value") %>%
  ggplot(aes(x = date, y = value, color = band_type)) +
  geom_point(size = 0.7, alpha = 0.4) + 
  facet_wrap(~variable, scale="free", ncol = 4) +
  theme_linedraw()
```

On affiche également un nuage de points simple des occurrences de _banding_:

```{r fig.align='center', fig.height=4, fig.width=4, warning=FALSE}
cylinders %>%
  select(date, band_type) %>%
  ggplot(aes(x = date, y = band_type)) +
  geom_point(size = 0.7, alpha = 0.4) + 
  theme_linedraw()
```

Avec ces deux graphiques, on constate que du _banding_ apparaît systématiquement
à partir de 1992 environ. On calcule cette date plus précisément:

```{r}
cylinders %>%
  select(date, band_type) %>%
  group_by(band_type) %>%
  summarise(first=min(date), last=max(date))
```

Cette date butoir correspond donc au 24 novembre 1991; au delà de cette date,
tous les rouleaux sont défectueux.

On peut visualiser cette répartition avec le graphique suivant:

```{r}
cylinders %>%
  select(date, band_type) %>%
  group_by(band_type) %>%
  summarise(
    count_before = sum(date <= as.Date("1991-11-24")),
    count_after = sum(date > as.Date("1991-11-24"))
  ) %>%
  pivot_longer(cols = c(count_before, count_after), names_to = "condition", values_to = "count") %>%
  mutate(condition = ifelse(condition == "count_before", "Before", "After"),
         condition = factor(condition, levels = c("Before", "After"))) %>%
  ggplot(aes(x = condition, y = count, fill = band_type)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Condition", y = "Count", fill = "Band Type") +
  scale_fill_manual(values = c("gray", "black")) +
  theme_linedraw()
```

# Sélection des attributs

_Note: Cliquez sur un graphique pour l'agrandir_

Avant d'entraîner un modèle, il est judicieux d'effectuer
une sélection des attributs pertinents pour simplifier ce dernier dans la mesure
du possible.

À l'aide des différents résultats et graphiques du point précédent, 
on peut identifier des attributs peu pertinents:

##### Attributs qualitatifs

* `cylinder_division` et `ink_color`: Toujours les mêmes valeurs.
* `direct_steam` et `blade_mfg` : Très peu de diversité dans les valeurs.
* `cylinder_no`, `customer` et `job_number` : Grand nombre de classes.
* `location` : Grand nombre de valeurs manquantes.

##### Attributs quantitatifs

* `chrome_content`, `current_density` et `ESA_amperage` : Très peu de variance.

Ignorons ceux-ci pour la suite:

```{r}
cylinders<-cylinders %>%
  select(-cylinder_division, -ink_color, -direct_steam, -blade_mfg,
         -chrome_content, -current_density, -ESA_amperage,
         -cylinder_no, -customer, -job_number,
         -location)
```

# Création et application du modèle

_Note: Cliquez sur un graphique pour l'agrandir_

Division des données en ensembles d'entraînement et de test:

```{r}
set.seed(19)

# 80% de données d'entraînement
smp.size<-floor(0.8 * nrow(cylinders))
idx.train<-sample(seq_len(nrow(cylinders)), size = smp.size)

cylinders.train<-cylinders[idx.train, ]
cylinders.test<-cylinders[-idx.train, ]
```

## Classification

Utilisation d'un arbre de classification pour le modèle:

```{r}
cylinders.ct<-rpart(band_type ~., data = cylinders.train, cp=0.001)
cylinders.ct
```

Affichage de l'arbre de classification:

```{r fig.align='center', fig.width=8, fig.height=12}
plot(cylinders.ct, cex = 1)
text(cylinders.ct, cex = 0.6)
```

Autre variante : 

```{r fig.align='center', fig.width=7, fig.height=4}
rpart.plot(cylinders.ct, main="")
```

Affichage d'informations sur l'arbre:

```{r}
printcp(cylinders.ct)
```

On constate que la date est le critère le plus significatif.

# Test du modèle

_Note: Cliquez sur un graphique pour l'agrandir_

Application de la classification sur les données de test, afin de vérifier
l'efficacité du modèle:

```{r}
cylinders.pred<-predict(cylinders.ct, cylinders.test, type = "class")
confusionMatrix(data = cylinders.pred, reference = cylinders.test$band_type)
```
